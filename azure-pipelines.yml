stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'Ubuntu-16.04'
    variables:
    - group: secrets
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '11.x'
      displayName: 'Install Node.js'
    - script: |
        npm install
      displayName: 'npm install'
    - script: |
        npm run test
      displayName: 'run tests'
    - script: |
        npm run build -- --prerender
      displayName: 'Build'
    - script: |
        export HOST_IP="$(hostname -i | awk '{print $1}')"
        export BUILD_ID='$(Build.BuildId)'
        npm run browserstack
      displayName: 'Run browserstack e2e tests'
      env:
        browserstackkey: $(browserstackkey)
        browserstackuser: $(browserstackuser)
    - task: PublishPipelineArtifact@0
      inputs:
        artifactName: 'www'
        targetPath: '$(System.DefaultWorkingDirectory)/www'
- stage: Release
  jobs:
  - job: Release
    pool:
      vmImage: 'vs2017-win2016'
    variables:
    - group: secrets
    steps:
    - task: DownloadPipelineArtifact@0
      inputs:
       artifactName: 'www'
       targetPath: $(System.DefaultWorkingDirectory)/www
    - script: 'npm install -g firebase-tools'
      displayName: 'Firebase tools'
    - script: 'firebase deploy --token $(fb_ci_token) --project $(fb_production_project) --message "Release: $(Release.ReleaseName)"'
      workingDirectory: '$(System.DefaultWorkingDirectory)/_INSPIRATIONlabs.website/pipelineArtifacts'
      displayName: 'Firebase deploy'

