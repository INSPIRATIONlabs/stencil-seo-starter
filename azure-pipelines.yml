stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'Ubuntu-16.04'
    variables:
    - group: secrets
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '11.x'
      displayName: 'Install Node.js'
    - script: |
        sudo dotnet tool install --global Prerenderer
      displayName: 'Install prerenderer'
    - script: |
        npm install
      displayName: 'npm install'
    - script: |
        npm run test
      displayName: 'run tests'
    - script: |
        npm run build
      displayName: 'Build'
    - script: |
        source /etc/profile
        Prerenderer -u http://localhost:5000/urls.json -i $(Build.SourcesDirectory)/www/assets/prerender.js -o output -s $(Build.SourcesDirectory)/www/ -m https://stencil-router-starter1.com
        cp $(Build.SourcesDirectory)/www/sw.js $(Build.SourcesDirectory)/output/
        cp -r $(Build.SourcesDirectory)/www/workbox-* $(Build.SourcesDirectory)/output/
        cp $(Build.SourcesDirectory)/www/404.html $(Build.SourcesDirectory)/output/
      displayName: 'Prerender site'
    - script: |
        export HOST_IP="$(hostname -i | awk '{print $1}')"
        export BUILD_ID='$(Build.BuildId)'
        npm run browserstack
      displayName: 'Run browserstack e2e tests'
      env:
        browserstackkey: $(browserstackkey)
        browserstackuser: $(browserstackuser)
    - task: PublishPipelineArtifact@0
      inputs:
        artifactName: 'pipelineArtifacts'
        targetPath: '$(System.DefaultWorkingDirectory)'
- stage: Release
  jobs:
  - job: Release
    pool:
      vmImage: 'vs2017-win2016'
    variables:
    - group: secrets
    steps:
    - script: 'npm install -g firebase-tools'
      displayName: 'Firebase tools'
    - script: 'firebase deploy --token $(fb_ci_token) --project $(fb_production_project) --message "Release: $(Release.ReleaseName)"'
      workingDirectory: '$(System.DefaultWorkingDirectory)/_INSPIRATIONlabs.website/pipelineArtifacts'
      displayName: 'Firebase deploy'

